# 要件定義書 - ブロックチェーンRAID5

## 1. はじめに

### 1.1. 背景・目的

#### 1.1.1. 目的
本システムの目的は、テキストやバイナリといったWEBリソースをブロックチェーン上に永続的に保存する「オンチェーンWEB」を実現することにある。その際、リソースを断片化し、複数のブロックチェーンに分散して保存する仕組みを構築する。

#### 1.1.2. 背景
一般的なブロックチェーンには、ネットワーク帯域や同期速度の観点からブロックごとにサイズ上限が設けられている。例えば、イーサリアムのブロックサイズ上限は約22KBと非常に小さく、10MBのファイルを保存しようとすると466個のブロック生成が必要となり、その間ネットワークを占有してしまう。この問題を解決し、大容量のデータをオンチェーンに保存可能とする新たな仕組みが必要である。

### 1.2. システム概要
本システムは、複数のブロックチェーン（データチェーン）を束ね、RAID5に類似した分散ストレージとして機能させる。

- WEBリソースを固定サイズの「データ断片」に分割する。
- 各断片を、それぞれ異なるデータチェーンに並列で保存する。
- どの断片がどのチェーンに保存されているかの所在情報（メタデータ）は、別途「メタデータチェーン」で一元管理する。
- クライアントからのリクエストを受け、データの断片化・分散保存・復元を行う「コントローラー」を中核コンポーネントとして配置する。

このアーキテクチャにより、単一チェーンのブロックサイズ上限に縛られることなく、実質的にスケーラブルなオンチェーンストレージを実現する。

### 1.3. 用語定義
- **現時点で定義されている内容**
    - **コントローラー:** WEBリソースを断片化してデータチェーンに保存したり、逆にデータチェーンから断片を取得して復元するコンポーネント。オフチェーンに配置される想定。
    - **メタデータチェーン (metachain):** どのデータ断片がどのデータチェーンにあるかというハッシュ情報（メタデータ）を記録・管理するブロックチェーン。
    - **データチェーン (datachain):** 断片化されたWEBリソースの実データを保存するためのブロックチェーン。複数台稼働させる。
    - **リレイヤー:** IBCプロトコルに基づき、各チェーン間の状態を同期させるために必要なコンポーネント。

- **追加・確認が必要な内容**
    - `IBC (Inter-Blockchain Communication)`
    - `Cosmos SDK`
    - `パリティ`
    - `DENOM`
    - `ニーモニック`
    - 上記を含む、プロジェクト内で利用される技術用語や概念の定義を網羅的にリスト化し、関係者間の認識を統一する必要がある。

## 2. 基本要件

### 2.1. 利害関係者（ステークホルダー）
- **定義が必要な内容**
    - 本システムを利用する「クライアント」とは具体的に誰を指すのか？ (例: Web3アプリケーション開発者, 一般企業, 個人ユーザー)
    - 本システムの管理・運用は誰が行うのか？
    - 本システムの開発者は誰か？

### 2.2. システムのスコープ
- **現時点で定義されている内容（やること）**
    - WEBリソース（ファイル）のアップロード機能。
    - URLを指定したWEBリソースのダウンロード機能。

- **追加・確認が必要な内容（やらないこと）**
    - 一度アップロードしたファイルの更新・削除機能は提供するか？
    - ユーザー認証や、ファイルごとのアクセス制御は実装するか？
    - ファイルのアップロードやダウンロードに対する課金モデルは導入するか？

## 3. 機能要件

### 3.1. 機能一覧
- **定義が必要な内容**
    - 基本機能であるアップロード/ダウンロード以外に、以下の機能が必要か定義する必要がある。
        - アップロードされたファイルの一覧表示機能
        - ファイルの検索機能
        - ファイルの更新・削除機能

### 3.2. 業務フロー（ユースケース）

#### 3.2.1. アップロード処理
| ステップ | 担当 | アクション |
| :--- | :--- | :--- |
| **1. 指示** | **クライアント** | アップロードしたいファイルと公開URLを**コントローラー**に渡す。 |
| **2. 分割** | **コントローラー** | 受け取ったファイルを固定サイズの「データ断片」に分割し、任意で「パリティ断片」を生成する。 |
| **3. 分散保存** | **コントローラー** → **Datachain** | 各断片を、それぞれ別の**Datachain**に並列で送信し、保存先を示す`Index`を受け取る。 |
| **4. 住所録作成** | **コントローラー** | 全ての断片の`Index`をURLと紐付けた「メタデータ（住所録）」を作成する。 |
| **5. 住所録登録** | **コントローラー** → **Metachain** | 作成したメタデータを**Metachain**に送信し、登録を依頼する。 |
| **6. 完了** | **コントローラー** → **クライアント** | **Metachain**への登録完了後、クライアントに完了通知を送る。 |

#### 3.2.2. ダウンロード処理
| ステップ | 担当 | アクション |
| :--- | :--- | :--- |
| **1. 要求** | **クライアント** | 閲覧したいURLを**コントローラー**に渡す。 |
| **2. 住所確認** | **コントローラー** → **Metachain** | **Metachain**にURLに対応するメタデータ（住所録）を問い合わせる。 |
| **3. 住所取得** | **Metachain** → **コントローラー** | **Metachain**は「断片データのありかリスト」をコントローラーに返却する。 |
| **4. データ収集** | **コントローラー** → **Datachain** | リストに基づき、各**Datachain**にデータ断片を並列で問い合わせる。 |
| **5. 結合・復元** | **コントローラー** | 全てのデータ断片を結合して元のファイルを復元する。（一部欠損時はパリティ断片で復元） |
| **6. 表示** | **コントローラー** → **クライアント** | 復元したファイルをクライアントに渡し、表示させる。 |

### 3.3. データ要件

- **`datachain`**
    - **構造:** `index`と`data`フィールドで構成されたKey-Value型のデータ構造。
    - **概要:** 断片化されたWEBリソースデータを保存する。

- **`metachain`**
    - **構造:** `{ url: string, address_hash: string[] }`
    - **概要:** 特定のURLに紐づく各データ断片の保存先アドレス（ハッシュ）のリストを保持する。

### 3.4. 管理機能要件
- **定義が必要な内容**
    - 各チェーン（metachain, datachain）の死活監視やリソース（ディスク使用量、トランザクション詰まり等）を監視する機能。
    - 新しいデータチェーンをシステムに追加・削除する手順。
    - 不正なコンテンツのアップロードを検知・ブロックする機能。

### 3.5. 異常系（エラーハンドリング）要件
- **定義が必要な内容**
    - アップロード中に一部のデータチェーンが応答しない場合のリトライ処理、タイムアウト処理、エラー通知の仕様。
    - ダウンロード時にデータが欠損しており、パリティでも復元できない場合のクライアントへの応答仕様。
    - メタデータチェーンへの書き込みが失敗した場合のロールバック処理の仕様。
    - コントローラー自体がダウンした場合の縮退運転や復旧手順。

## 4. 非機能要件

### 4.1. 性能・拡張性
- **定義が必要な内容**
    - **応答時間:** 特定のファイルサイズ（例: 10MB, 100MB）におけるアップロード/ダウンロードの目標時間。
    - **スループット:** システム全体で1秒あたりに処理可能なリクエスト数の目標値。
    - **拡張性:** 将来的にデータチェーンを何台までスケールアウトさせることを想定しているか。

### 4.2. 可用性・信頼性
- **定義が必要な内容**
    - **稼働率:** システム全体の目標稼働率（例: 99.9%）。
    - **冗長性:** データチェーンが何台まで同時に停止しても、ファイルのダウンロード機能を維持できるか。
    - **目標復旧時間 (RTO):** 障害発生時に何時間（何分）以内にシステムを復旧させるか。
    - **目標復旧時点 (RPO):** 障害発生時にどの時点のデータまで復旧を保証するか。

### 4.3. セキュリティ
- **定義が必要な内容**
    - **認証・認可:** コントローラーを操作するための認証・認可方式（例: APIキー, OAuth2.0）。
    - **データ保護:** 保存するデータおよびクライアント-コントローラー間の通信経路の暗号化は必要か。
    - **鍵管理:** 各チェーンノードやリレイヤーが使用する秘密鍵をどのように安全に管理・運用するか。
    - **アクセス制御:** 特定のIPアドレスからのアクセス制限などは必要か。

### 4.4. 運用・保守性
- **現時点で定義されている内容**
    - `datachain`, `metachain`, `relayer` のDockerコンテナによる環境構築手順。
    - 各チェーンの起動時に、設定ファイル（`genesis.json`, `config.toml`, `app.toml`）を自動生成・構成する仕組み。
    - 冪等性（何度実行しても同じ状態になること）を考慮した初期化スクリプトの設計。

- **追加・確認が必要な内容**
    - **ログ設計:** 各コンポーネントが出力するログの内容、フォーマット、レベル（Info, Error 등）、およびログの収集・管理方法。
    - **監視設計:** 各コンポーネントの何を監視し（死活、CPU/メモリ使用率、ディスクI/O）、どのような閾値でアラートを通知するか。
    - **バックアップ・リストア:** 各チェーンの状態や設定ファイルのバックアップ手順と、障害発生時のリストア手順。

### 4.5. UI/UX要件
- **定義が必要な内容**
    - コントローラーが外部（クライアント）に提供するAPIのエンドポイント、HTTPメソッド、リクエスト/レスポンスのデータフォーマット仕様。
    - （もし必要であれば）システム管理者が利用する管理画面のワイヤーフレームや画面遷移図。

## 5. 制約条件

### 5.1. 技術的制約
- **ブロックチェーン基盤:** Cosmos SDKを利用して独自のチェーンを構築する。
- **チェーン間通信:** IBC (Inter-Blockchain Communication) プロトコルを利用する。
- **実行環境:** 各コンポーネントはDockerコンテナとして構築し、Docker ComposeやKubernetes(k8s)によるオーケストレーションを想定する。
- **開発言語:** Go（`datachaind`コマンドの存在から推測）。
- **アーキテクチャ:** コントローラーはオフチェーンコンポーネントとして実装する。

### 5.2. プロジェクト制約
- **定義が必要な内容**
    - **予算:** 本プロジェクトに割り当てられた開発・運用予算。
    - **スケジュール:** リリース目標日、および主要な機能開発のマイルストーン。
    - **開発体制:** 開発チームの人数、役割分担（PM, エンジニア, etc.）。

## 6. その他

### 6.1. 移行要件
- **定義が必要な内容**
    - 既存のストレージシステムから本システムへデータを移行する必要があるか。ある場合、その手順と計画。

### 6.2. テスト計画
- **定義が必要な内容**
    - 単体テスト、結合テスト、性能テスト、セキュリティテストなど、各テストフェーズの方針と合格基準。

### 6.3. 納品物
- **定義が必要な内容**
    - プロジェクト完了時に納品する成果物の一覧。（例: 要件定義書、設計書、ソースコード一式、テスト報告書、運用マニュアル）